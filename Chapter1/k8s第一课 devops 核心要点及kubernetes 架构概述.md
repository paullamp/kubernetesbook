## k8s第一课 devops 核心要点及kubernetes 架构概述

### 应用编排工具的变化
ansible:应用编排工具，日常的运维工作，整合进一个playbook中
puppet:
saltstack:
docker: 是新式的面向容器化的应用编排工具
- docker 自身提供的编排工具
    - docker-compose:适合于单机编排，只能面向一个docker-host 进行应用编排
    - docker swarm: 将多个docker-host 提供的集群资源整合在一个集群资源池中，进行集群范围的统一编排
    - docker-machine: 将一个docker主机加入到docker-swarm集群中的一份子，是一个将主机加进docker swarm集群的预处理工具
- 其他厂商提供的编排工具
	- mesos :idc os ,将一个idc的资源进行统一调度
		- marathon： 基于容器调度的架构
	- kubernetes
		- 一个产品只要能占用35%以上的市场份额，那么就可以形成垄断

### 应用开发以及编排的理念
运维的一些概念：
- DEVOPS
- microservice
- blockchain

应用的开发模式：
- 瀑布式
- 敏捷开发
- 精益开发

应用层的架构：
- 单体架构：单体架构，由于资源或是单体内性能饼颈
- 分层架构：如常见的分层架构，nginx-tomcat-redis-mysql
- 微服务架构：单体架构，有可能需要拆解成上百个微服务，带来微服务间的调度关系

Devops中的一些概念：
- CI: 持续集成
- CD: 持续交付Delivery,提供到下一环节
- CD: 持续部署Deployment，提供给生产线正式运行
发布过程:
- 蓝绿
- 金丝洽

开发过程
~~~ mermaid 
graph LR;
产品计划--> 架构设计;
架构设计--> 开发;
开发--> 构建;
构建-->测试;
测试--> 部署;
~~~
当程序员开发完代码后，提交到代码库(git/svn)，有构建工具，可以自动触发相关的构建／测试／部署等后续流程。
容器出现后，拉平了底层系统／环境的异构平台，一个容器可以在所有系统上运行。
容器及编排工具使得devops的实现更加容易。
devops不是一种具体的技术，是一种文化，一种处理的模式，用于突破dev  和ops之间的沟通墙。
kubernetes 的中文意是搬手，飞行员。于2014年开放。是基于google内部的borg系统用于调度容器调度。当容器技术流行了，google为了保证在容器世界的话语权，由golang开发了k8s.国人投入了大量的精力用于k8s的开发和使用。　
k8s1.0版大概在2015.7月发布。现在已经到1.11版本。(2018/08/07). 大概维持在一年４个版本的速度在发布
2017年，是容器技术发展的重要的一年。世面上最大的云商都可以支持k8s.可以快速部署。部分云商也可以直接提供容器即服务的产品形态。
docker swarm也同样支持k8s.
rkt , fleet 另一种容器以及容器的编排工具。rkt是coreos产品，现在已经被红帽收购。
k8s也被红帽收录成paas。对应于红帽发行的openshift . openshift是k8s的发行版。

###k8s的特性:

- 自动装箱
- 自我修复：容器挂了，可以快速启动，秒级启动（依赖容器内程序的启动时间）
- 有了k8s平台后，更多关注的是容器整体，不再关注个体
- 实现水平扩展
- 服务发现：自注册和找到所依赖的服务
- 服务负载均衡
- 自动发布和回滚
- 密钥和配置管理（非云原生的应用，可以通过环境变量／entrypoint进行配置文件替换），从外部的配置中心中自动加载配置文件。
	- 以前是使用ansile类的配置文件推送。
	- 配置信息存放在服务器上，通过第三方服务器加载配置；配置中心
- 存储编排，实现存储卷的编排
- 批处理执行

### k8s架构
k8s可以理解为是一个容器集群的管理工具。
常用的集群架我：
- p2p: 无中心节点，每个节点都能进行请求处理
- 有中心节点：　类似于hdfs,mysql主从架构,存在中心节点，中心节点故障可能会对整集群产生重大影响。 
- master上的组件:　APIserver, Scheduler, controller-manager
- nodes上的组件: kubelet, 容器引擎(docker/rkt),daemon set

k8s是一种有中心节点的集群架构。master-nodes架构:
#### master
- master:　接收用户请求，由master中的调度器，分析node中的资源状态。找到最佳的可运行用户容器的节点，再由node负责运行。master提供api服务，用于接收客户端的请求。
- apiserver : 接收客户端请求，可以是客户端工具，或是编译工具，通过调用接口
- scheduler:  负责收集所有node的运行资源状态，并且可以为容顺分配有合适资源的节点，容器可以要求有特定的资源上限（资源阀值）以及资源下线（资源运行请求）。
	- 两级调度，先选出符合条件的
	- 再进行优选，选择最佳的node
- kubelet:负责容器一直处理运行状态。如果docker-host　down机后，则可以通过scheduler进行重新高度。
- controller：周期性探测容器的运行状态，如果容器运行不在用户期望的状态，则可以让容器往超望状态驱近。
- controller-manager: 用于监控和管理每个控制器是健康的，需要冗余

#### nodes
- nodes(worker):　供献计算／存储能力。运行用户容器的节点
- 负责运行master指定的各种任务，主要是运行pod。

#### Pod

- 调度单元: k8s中,POD是调度的最小逻辑单元，而不是容器。pod可以理解成为是docker容器的一种封装（外壳）。pod内的多个容器共享net,uts,ipc等名称空间，其他的三个名称空间pid,mount,user在容器内独立。pod可以模拟类似虚拟机的运行模式。
- 存储卷: 同一pod内的容器，也可以共享同一个存储卷。也就是说存储卷是归属于pod .而非之前一样，归属于容器。
- 容器与pod: 一般说来，　一个pod内只运行一个容器。除非是pod内的容器有强关联关系。通常其中一个是主容器，其他的容器为了辅助主容器进行的sidecar.
- 标签：　为了增加pod的识别，需要为pod附加一些元数据。可以为pod打上相应的标签。让控制器可以根据标签的值来进行pod的筛选。通过selector来提供标签选择（过滤）功能。

*master/node结构，master一般可以有三个，　nodes可以达数千上万个。*


